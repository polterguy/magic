
<div class="row h-100 ide">

  <div class="col-12 mb-general">
    <mat-card class="h-100 p-0">
      <mat-card-content class="h-100">
        <mat-sidenav-container autosize="true">

          <!-- Drawer for tree view of files and folders on server -->
          <mat-sidenav
            #drawer
            [mode]="largeScreen ? 'side' : 'over'"
            [opened]="startResizing && largeScreen ? true : false">

            <!-- Treeview for files and folders on server -->
            <mat-tree
              [dataSource]="dataSource"
              [treeControl]="treeControl"
              class="pb-5">

              <!-- Tree nodes for files -->
              <mat-tree-node
                *matTreeNodeDef="let file"
                [class]="currentFileData?.path === file.node.path ? 'selected-node' : 'node'"
                matTreeNodePadding
                matTreeNodePaddingIndent="10"
                class="pr-3">
                <button
                  class="w-100 px-1 d-flex justify-content-start ml-4"
                  mat-button
                  (click)="openFile(file.node);">
                  <mat-icon class="mat-icon-rtl-mirror mr-2 ml-1">insert_drive_file</mat-icon>{{file.name}} {{file.node.systemFile}}
                </button>
              </mat-tree-node>

              <!-- Tree nodes for folders -->
              <mat-tree-node
                *matTreeNodeDef="let folder; when: isExpandable"
                [class]="activeFolder === folder.node.path ? 'selected-node' : 'node'"
                [class.warning]="folder.node.systemFile"
                matTreeNodePadding
                matTreeNodePaddingIndent="10" [isExpanded]="activeFolder === folder.node.path"
                class="pr-3">
                <div class="d-flex w-100 h-100 flex-nowrap align-items-center">
                  <button
                    mat-button
                    class="px-1"
                    matTreeNodeToggle
                    [matTooltip]="folder.node.systemFile ? 'Do not modify unless you know what you\'re doing' : ''"
                    matTooltipPosition="after">
                    <mat-icon class="mat-icon-rtl-mirror">
                      {{treeControl.isExpanded(folder) ? 'expand_more' : 'chevron_right'}}
                    </mat-icon>
                    <mat-icon class="mat-icon-rtl-mirror">{{treeControl.isExpanded(folder) ? 'folder_open' : 'folder'}}</mat-icon>
                  </button>
                  <button
                    mat-button
                    (click)="selectFolder(folder);treeControl.expand(folder)"
                    class="px-1 d-flex justify-content-start w-100">
                    {{folder.name}} 
                  </button>
                </div>
              </mat-tree-node>

            </mat-tree>

            <div class="system-files-toggle">
              <mat-slide-toggle
                [(ngModel)]="systemFiles" color="accent"
                (change)="toggleSystemFiles()">System files</mat-slide-toggle>
            </div>

          </mat-sidenav>
        
          <div class="content-section d-flex flex-column w-100 h-100 p-3">

            <!-- Form and action buttons -->
            <div class="d-flex pb-2 align-items-center mt-1">

              <!-- Toggle treeview button -->
              <button
                type="button"
                mat-icon-button
                (click)="drawer.toggle()"
                [matTooltip]="drawer.opened ? 'Collpase Folders' : 'Expand Folders'">
                <mat-icon class="material-icons-outlined">{{drawer.opened ? 'drive_file_move_rtl' : 'drive_file_move'}}</mat-icon>
              </button>

              <!-- Select file dropdown -->
              <mat-form-field appearance="outline" class="w-100 inline-input">
                <mat-label>{{openFiles.length > 0 ? 'Open files ...' : 'No open files yet'}}</mat-label>
                <mat-select
                  [(ngModel)]="currentFileData"
                  (selectionChange)="selectedFileChanged()">
                  <mat-option
                    *ngFor="let idx of openFiles"
                    [value]="idx">{{idx.folder}}<strong>{{idx.name}}</strong></mat-option>
                </mat-select>
              </mat-form-field>

              <!-- Action buttons -->
              <div>

                <!-- Trigger action menu button -->
                <button
                  mat-icon-button
                  [matMenuTriggerFor]="actions"
                  matTooltip="Actions">
                  <mat-icon>more_vert</mat-icon>
                </button>

                <!-- Sub menu for types of actions -->
                <mat-menu #actions="matMenu">

                  <button
                    mat-menu-item
                    [matMenuTriggerFor]="submenu1"
                    class="submenu-before">
                    <div class="pl-4 w-100 h-100">
                      General
                    </div>
                  </button>

                  <button
                    mat-menu-item
                    [matMenuTriggerFor]="submenu2"
                    class="submenu-before">
                    <div class="pl-4 w-100 h-100">
                      Active folder
                    </div>
                  </button>

                  <button
                    mat-menu-item
                    [matMenuTriggerFor]="submenu3"
                    class="submenu-before"
                    [disabled]="!currentFileData"
                    [matMenuTriggerData]="{data: currentFileData}">
                    <div class="pl-4 w-100 h-100">
                      Active file
                    </div>
                  </button>

                </mat-menu>

                <!-- General menu -->
                <mat-menu #submenu1="matMenu" class="submenu">
                  <app-general-actions
                    (updateFiles)="updateFileObject($event)"></app-general-actions>
                </mat-menu>

                <!-- Active folder menu -->
                <mat-menu #submenu2="matMenu" class="submenu">
                  <app-folder-actions
                    [activeFolder]="activeFolder"
                    [getFiles]="getFiles()"
                    [getFolders]="getFolders()"
                    (manageAfterCreateNewFileObject)="manageAfterCreateNewFileObject($event)"
                    (updateFiles)="updateFileObject($event)"
                    (updateAfterDelete)="updateAfterDeleteFolder()"
                    (updateAfterMacro)="updateAfterMacro($event)"
                    (afterRenamingFolder)="afterRenamingFolder($event)"></app-folder-actions>
                </mat-menu>
                
                <!-- Active file menu -->
                <mat-menu #submenu3="matMenu" class="submenu">
                  <app-file-actions
                    [currentFileData]="currentFileData" 
                    (getEndpoints)="getEndpoints()"
                    (insertHyperlambda)="insertHyperlambda($event)"
                    (getEndpoint)="currentFileData ? getEndpoint($event) : ''"
                    [endpointData]="currentFileData ? getEndpoint(currentFileData) : ''"
                    [openFiles]="openFiles"
                    (renameActiveFileFromParent)="renameActiveFile($event)"
                    (deleteActiveFileFromParent)="deleteActiveFile($event)"
                    (closeFileImplFromParent)="closeFileImpl()"></app-file-actions>
                </mat-menu>
              </div>

              <!-- Help button -->
              <div class="sm-icons mr-2">
                <button
                  mat-icon-button
                  [matMenuTriggerFor]="menu"
                  class="mat-caption"
                  matTooltip="Need help?"
                  type="button">
                  <mat-icon>help_outline</mat-icon>
                </button>

                <mat-menu #menu="matMenu">
                  <div class="p-3">
                    <p>
                      Create and modify your programs here. The tree to the left on your screen displays
                      all files that exists in your server. If you click a file here, you can edit it directly
                      and save it.
                    </p>
                    <div class="d-flex justify-content-end">
                      <a target="_blank" href="https://docs.aista.com/documentation/magic/components/hyper-ide/" mat-stroked-button>Learn more</a>
                    </div>
                  </div>
                </mat-menu>
              </div>

              <!-- Shortkeys button -->
              <button
                mat-stroked-button
                [matMenuTriggerFor]="list"
                matTooltip="List of shortkeys"
                class="d-lg-block d-none shortkey-btn">
                Shortkeys
              </button>

              <!-- Shortkeys menu -->
              <mat-menu #list="matMenu" class="shortkeys">
                <mat-list role="list" dense>

                  <mat-list-item role="listitem">
                    Toggle fullscreen
                    <span class="code my-0 ml-5">Alt + M</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Search
                    <span class="code my-0 ml-5">Ctrl+F/Cmd+F</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Find next
                    <span class="code my-0 ml-5">Ctrl+G/Cmd+G</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Find previous
                    <span class="code my-0 ml-5">Shift+Ctrl+G/<br>Shift+Cmd+G</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Replace
                    <span class="code my-0 ml-5">Shift+Ctrl+F/<br>Cmd+Option+F</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Replace all
                    <span class="code my-0 ml-5">Shift+Ctrl+R/<br>Shift+Cmd+Option+F</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Jump to line
                    <span class="code my-0 ml-5">Alt + G</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Save active file
                    <span class="code my-0 ml-5">Alt + S</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Execute active file
                    <span class="code my-0 ml-5">F5</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Preview active file
                    <span class="code my-0 ml-5">ALT + P</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Insert snippet
                    <span class="code my-0 ml-5">ALT + V</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Close active file
                    <span class="code my-0 ml-5">Alt + C</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Rename active file
                    <span class="code my-0 ml-5">Alt + R</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Rename active folder
                    <span class="code my-0 ml-5">Alt + L</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Delete active file
                    <span class="code my-0 ml-5">Alt + D</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Delete active folder
                    <span class="code my-0 ml-5">Alt + X</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Execute macro
                    <span class="code my-0 ml-5">Alt + O</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Create new file
                    <span class="code my-0 ml-5">Alt + A</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Create new folder
                    <span class="code my-0 ml-5">Alt + B</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Show autocomplete
                    <span class="code my-0 ml-5">CTRL + SPACE</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Indent
                    <span class="code my-0 ml-5">TAB</span>
                  </mat-list-item>

                  <mat-list-item role="listitem">
                    Deindent
                    <span class="code my-0 ml-5">SHIFT + TAB</span>
                  </mat-list-item>

                </mat-list>
              </mat-menu>
            </div>

            <!-- Lightbulb shown when there are no open files -->
            <img
              *ngIf="openFiles.length === 0"
              src="assets/light-bulb.png"
              class="light-bulb"
              matTooltip="Hyper IDE, where the machine creates the code"
              alt="Hyper IDE, where the machine creates the code">

              <!-- CodeMirror editors wrapping currently open files -->
              <div
                *ngFor="let file of openFiles"
                class="w-100 d-flex flex-column justify-content-start"
                [class]="file.path === currentFileData.path ? 'h-100': ''">
                <div
                  [class]="file.path === currentFileData.path ? 'active-codemirror-editor d-flex flex-column' : 'd-none'"
                  class="h-100 w-100">
                  <ngx-codemirror
                    class="codemirror-container h-100"
                    [(ngModel)]="file.content"
                    [options]="file.options">
                  </ngx-codemirror>
                </div>
              </div>

          </div>
        </mat-sidenav-container>
        
      </mat-card-content>
    </mat-card>
    
  </div>

</div>
